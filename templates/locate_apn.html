{% extends "layout.html" %}

{% block title %}Locate APN {{ apn.DPN }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Locate APN: {{ apn.DPN }}</h2>
            <a href="javascript:history.back()" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-1"></i> Back
            </a>
        </div>
        
        <div class="card-body">
            {% include '_flashes.html' %}
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <h4 class="mb-3">APN Details</h4>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <tbody>
                                <tr>
                                    <th width="30%">ID</th>
                                    <td>{{ apn.PIN_id }}</td>
                                </tr>
                                <tr>
                                    <th>DPN</th>
                                    <td>{{ apn.DPN }}</td>
                                </tr>
                                <tr>
                                    <th>Type</th>
                                    <td>{{ apn.Type }}</td>
                                </tr>
                                <tr>
                                    <th>Location</th>
                                    <td><strong>ARMOIRE {{ location.cabinet }}-{{ location.drawer }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="col-md-6 text-center">
                    <h4 class="mb-3">APN Image</h4>
                    {% if apn.Image %}
                        {% set apn_img_url = '' %}
                        {% if '/pin/' in apn.Image %}
                            {% set apn_img_url = url_for('serve_apn_pin_image', filename=apn.Image.split('/')[-1]) %}
                        {% else %}
                            {% set apn_img_url = url_for('serve_apn_image', filename=apn.Image.split('/')[-1]) %}
                        {% endif %}
                        <img src="{{ apn_img_url }}" alt="APN Image" class="img-fluid rounded" style="max-height: 200px;">
                    {% else %}
                        <div class="alert alert-secondary p-2">No image available</div>
                    {% endif %}
                </div>
            </div>
            
            <h3 class="mb-4 text-center">Cabinet Visualization</h3>
            
            <div class="cabinet-visualization mb-5">
                <!-- Cabinet Visualization with Realistic Images -->
                <div class="row">
                    <div class="col-md-6 offset-md-3 text-center">
                        <div class="cabinet-container position-relative">
                            <!-- Cabinet base image -->
                            <div class="cabinet-image">
                                <svg width="300" height="500" viewBox="0 0 300 500" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Cabinet body -->
                                    <rect x="20" y="20" width="260" height="460" rx="5" fill="#555555" stroke="#333333" stroke-width="2"/>
                                    
                                    <!-- Cabinet top -->
                                    <rect x="10" y="10" width="280" height="20" rx="5" fill="#666666" stroke="#333333" stroke-width="2"/>
                                    
                                    <!-- Cabinet bottom -->
                                    <rect x="10" y="470" width="280" height="20" rx="5" fill="#666666" stroke="#333333" stroke-width="2"/>
                                    
                                    <!-- Cabinet badge/label -->
                                    <rect x="125" y="25" width="50" height="25" rx="3" fill="#888888" stroke="#444444" stroke-width="1"/>
                                    <text x="150" y="42" font-family="Arial" font-size="16" fill="white" text-anchor="middle" dominant-baseline="middle">{{ location.cabinet }}</text>
                                    
                                    <!-- Drawers -->
                                    {% for drawer_num in range(1, 13) %}
                                        {% set drawer_id = '%02d' % drawer_num %}
                                        {% set target_drawer = location.drawer|string %}
                                        {% set is_target = drawer_id == target_drawer or drawer_num|string == target_drawer %}
                                        {% set drawer_y = 50 + (drawer_num - 1) * 35 %}
                                        
                                        <g class="drawer {% if is_target %}target-drawer{% endif %}" transform="translate({% if is_target %}30{% else %}0{% endif %}, 0)">
                                            <rect x="30" y="{{ drawer_y }}" width="240" height="30" rx="3" 
                                                  fill="{% if is_target %}#FF8C00{% else %}#777777{% endif %}" 
                                                  stroke="#333333" stroke-width="1"/>
                                            
                                            <!-- Drawer handle -->
                                            <rect x="40" y="{{ drawer_y + 12 }}" width="30" height="6" rx="2" fill="#999999" stroke="#666666" stroke-width="1"/>
                                            
                                            <!-- Drawer label -->
                                            <text x="250" y="{{ drawer_y + 20 }}" font-family="Arial" font-size="14" 
                                                  fill="{% if is_target %}#000000{% else %}#ffffff{% endif %}" 
                                                  text-anchor="end" dominant-baseline="middle">{{ drawer_id }}</text>
                                        </g>
                                    {% endfor %}
                                    
                                    <!-- Debug info (remove in production) -->
                                    <text x="150" y="480" font-family="Arial" font-size="8" fill="#ffffff" text-anchor="middle">Target drawer: {{ location.drawer }}</text>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Cabinet Label -->
                        <h4 class="mt-3">ARMOIRE {{ location.cabinet }}</h4>
                    </div>
                </div>
                
                <div class="location-instructions mt-5 text-center">
                    <div class="alert alert-success p-4">
                        <h4><i class="fas fa-map-marker-alt me-2"></i> Location Found!</h4>
                        <p class="lead mt-3 mb-0">
                            <strong>APN {{ apn.DPN }}</strong> is located in <br>
                            <span class="fs-3">ARMOIRE {{ location.cabinet }}-{{ location.drawer }}</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animated visualization
        const targetDrawer = document.querySelector('.target-drawer');
        
        if (targetDrawer) {
            // Animation is now handled by a transform in the SVG
            
            // Add a pulsing animation to the target drawer
            setTimeout(function() {
                // Get the rect element inside the target drawer group
                const targetRect = targetDrawer.querySelector('rect');
                
                if (targetRect) {
                    // Add pulsing animation class
                    targetRect.classList.add('pulse-highlight');
                }
            }, 500);
        }
    });
</script>

<style>
    /* Keyframes for pulsing effect */
    @keyframes pulse-highlight {
        0% {
            filter: drop-shadow(0 0 0px rgba(255, 140, 0, 0.7));
        }
        50% {
            filter: drop-shadow(0 0 10px rgba(255, 140, 0, 1));
        }
        100% {
            filter: drop-shadow(0 0 0px rgba(255, 140, 0, 0.7));
        }
    }
    
    /* Apply animation to target drawer */
    .target-drawer rect {
        animation: pulse-highlight 2s infinite;
    }
    
    /* Smooth transition for drawer movement */
    .drawer {
        transition: transform 1.5s ease-in-out;
    }
    
    /* Enhance cabinet appearance */
    .cabinet-container {
        filter: drop-shadow(0 0 15px rgba(0, 0, 0, 0.5));
        margin: 0 auto;
        max-width: 300px;
    }
</style>
{% endblock %} 